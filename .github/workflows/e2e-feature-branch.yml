name: e2e for feature branch

on:
  push:
    branches:
      - CP-*
jobs:
  build:
    runs-on: ${{ matrix.runner_label }}
    strategy:
      matrix:
        runner_label: [linux-e2e, windows-e2e, macos-e2e]
        node-version: [22.15.0]
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Setup Env for Windows
        if: matrix.runner_label == 'windows-e2e'
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.MC_GITHUB_ACCESS_TOKEN }}
          FONTS_DIRECTORY_URL: ${{ secrets.FONTS_DIRECTORY_URL }}
          VITE_MUDITA_CENTER_SERVER_URL: ${{ secrets.MUDITA_CENTER_SERVER_URL }}
          E2ECI: "true"
        shell: cmd
        run: |
          SET > .env
          jq -r -j .version apps/app/package.json > apps/app/version
      - name: Setup Env for Mac
        if: matrix.runner_label == 'macos-e2e'
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.MC_GITHUB_ACCESS_TOKEN }}
          FONTS_DIRECTORY_URL: ${{ secrets.FONTS_DIRECTORY_URL }}
          VITE_MUDITA_CENTER_SERVER_URL: ${{ secrets.MUDITA_CENTER_SERVER_URL }}
          E2ECI: "true"
        run: |
          printenv > .env
      - name: Setup Env for Linux
        if: matrix.runner_label == 'linux-e2e'
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.MC_GITHUB_ACCESS_TOKEN }}
          FONTS_DIRECTORY_URL: ${{ secrets.FONTS_DIRECTORY_URL }}
          VITE_MUDITA_CENTER_SERVER_URL: ${{ secrets.MUDITA_CENTER_SERVER_URL }}
          E2ECI: "true"
        run: |
          printenv > .env
      - name: Changing app version in packages.json for Linux
        if: matrix.runner_label == 'linux-e2e'
        run: |
          export APP_VERSION=`cat apps/app/package.json | jq -r .version`
          export SOURCE_BRANCH=${{ github.ref_name }}
          export "ENVIRONMENT_CATALOG_NAME=feature-branch/${{ github.ref_name }}"
          export "BUILD_VERSION=-dev.${{ github.run_number }}"
          sed -i "s/\"version\": \".*\",/\"version\": \"$APP_VERSION$BUILD_VERSION\",/" apps/app/package.json
      - name: Changing app version in packages.json for Mac
        if: matrix.runner_label == 'macos-e2e'
        run: |
          export APP_VERSION=`cat apps/app/package.json | jq -r .version`
          export SOURCE_BRANCH=${{ github.ref_name }}
          export "ENVIRONMENT_CATALOG_NAME=feature-branch/${{ github.ref_name }}"
          export "BUILD_VERSION=-dev.${{ github.run_number }}"
          sed -i '' "s/\"version\": \".*\",/\"version\": \"$APP_VERSION$BUILD_VERSION\",/" apps/app/package.json
      - name: Changing app version in packages.json for Windows
        if: matrix.runner_label == 'windows-e2e'
        run: |
          $SOURCE_BRANCH = "${{ github.ref_name }}"
          $ENVIRONMENT_CATALOG_NAME = "feature-branch/${{ github.ref_name }}"
          $BUILD_VERSION = "-dev.${{ github.run_number }}"
          $APP_VERSION = (Get-Content -Path "apps/app/version") + $BUILD_VERSION
          (Get-Content -Path 'apps/app/package.json') | ForEach-Object {
            $_ -replace '"version": ".*",' , "`"version`"`: `"$APP_VERSION`","
          } | Set-Content -Path 'apps/app/package.json'
      - name: Setup dependencies
        run: npm run setup
      - name: Build App for Windows
        if: matrix.runner_label == 'windows-e2e'
        run: |
          $env:NODE_OPTIONS="--max-old-space-size=4096"
          $env:LOCALAPPDATA=""
          npx nx build:win app dir --output-style stream --no-cloud
      - name: Build App for Mac
        if: matrix.runner_label == 'macos-e2e'
        run: |
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          export NODE_OPTIONS="--max-old-space-size=4096"
          npx nx build:mac app dir --output-style stream --no-cloud
      - name: Build App for Linux
        if: matrix.runner_label == 'linux-e2e'
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          npx nx build:linux app dir --output-style stream --no-cloud
      - name: Run e2e (standalone) tests for Linux
        if: matrix.runner_label == 'linux-e2e'
        run: xvfb-run --auto-servernum --server-args='-screen 0 1024x768x24' npx nx start app-e2e --suite standalone --no-cloud --output-style stream
        shell: bash
      - name: Run e2e (standalone) tests for Mac/Windows
        if: matrix.runner_label != 'linux-e2e'
        run: npx nx start app-e2e --suite standalone --no-cloud --output-style stream
      - name: Run e2e (mock) tests for Linux
        if: matrix.runner_label == 'linux-e2e'
        run: xvfb-run --auto-servernum --server-args='-screen 0 1024x768x24' npx nx start app-e2e --suite mock --no-cloud --output-style stream
        shell: bash
      - name: Run e2e (mock) tests for Mac/Windows
        if: matrix.runner_label != 'linux-e2e'
        run: npx nx start app-e2e --suite mock --no-cloud --output-style stream
